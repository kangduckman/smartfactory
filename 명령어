
nginx ì¸ì¦ì„œ

step ca certificate \
  nginx-server \
  /home/ubuntu/certs/mtls_nginx.crt /home/ubuntu/certs/mtls_nginx.key \
  --provisioner "SF.CA" \
  --password-file /home/ubuntu/certs/pw.txt \
  --san 10.1.2.232 \
  --ca-url https://10.1.2.112:443 \
  --root /home/ubuntu/certs/root_ca.crt


ë””ë°”ì´ìŠ¤ ì¸ì¦ì„œ
step ca certificate \
  washer \
  /home/ubuntu/smartfactory/devices/washer_device/certs/mtls_washer.crt /home/ubuntu/smartfactory/devices/washer_device/certs/mtls_washer.key \
  --provisioner "SF.CA" \
  --password-file pw.txt \
  --ca-url https://10.1.2.112:443 \
  --root /home/ubuntu/smartfactory/devices/washer_device/certs/root_ca.crt

step ca certificate \
  capping \
  /home/ubuntu/smartfactory/devices/capper_device/certs/mtls_capper.crt /home/ubuntu/smartfactory/devices/capper_device/certs/mtls_capper.key \
  --provisioner "SF.CA" \
  --password-file pw.txt \
  --ca-url https://10.1.2.112:443 \
  --root /home/ubuntu/smartfactory/devices/capper_device/certs/root_ca.crt

step ca certificate \
  charger \
  /home/ubuntu/smartfactory/devices/charger_device/certs/mtls_charger.crt /home/ubuntu/smartfactory/devices/charger_device/certs/mtls_charger.key \
  --provisioner "SF.CA" \
  --password-file pw.txt \
  --ca-url https://10.1.2.112:443 \
  --root /home/ubuntu/smartfactory/devices/charger_device/certs/root_ca.crt

step ca certificate \
  labeling \
  /home/ubuntu/smartfactory/devices/labeling_device/certs/mtls_labeling.crt /home/ubuntu/smartfactory/devices/labeling_device/certs/mtls_labeling.key \
  --provisioner "SF.CA" \
  --password-file pw.txt \
  --ca-url https://10.1.2.112:443 \
  --root /home/ubuntu/smartfactory/devices/labeling_device/certs/root_ca.crt

#!/bin/bash

# ê¸°ë³¸ ë³€ìˆ˜ ì„¤ì •
DEVICE_NAME="washer"
CERT_DIR="/home/ubuntu/smartfactory/devices/washer_device/certs"
APP_PATH="/home/ubuntu/smartfactory/devices/washer_device/washer.py"
STEP_CA_URL="https://10.1.2.112:443"
ROOT_CA="$CERT_DIR/root_ca.crt"
CRT_FILE="$CERT_DIR/mtls_${DEVICE_NAME}.crt"
KEY_FILE="$CERT_DIR/mtls_${DEVICE_NAME}.key"
PW_FILE="$CERT_DIR/pw.txt"

# ì¸ì¦ì„œ ë°œê¸‰
echo "[ğŸ”] ì¸ì¦ì„œ ìš”ì²­ ì¤‘..."
step ca certificate \
  "$DEVICE_NAME" \
  "$CRT_FILE" "$KEY_FILE" \
  --provisioner "SF.CA" \
  --password-file "$PW_FILE" \
  --ca-url "$STEP_CA_URL" \
  --root "$ROOT_CA"

# Flask ì•± ì‹¤í–‰
echo "[ğŸš€] Flask ì•± ì‹¤í–‰ ì¤‘..."
python3 "$APP_PATH"


down

#!/bin/bash

DEVICE_NAME="washer"
CERT_DIR="/home/ubuntu/smartfactory/devices/washer_device/certs"

echo "[ğŸ§¼] ì¸ì¦ì„œ ì‚­ì œ ì¤‘..."
rm -f "$CERT_DIR/mtls_${DEVICE_NAME}.crt"
rm -f "$CERT_DIR/mtls_${DEVICE_NAME}.key"

step ë‹¤ìš´ë¡œë“œ
  # 1. CLI-only ë°”ì´ë„ˆë¦¬ ë‹¤ìš´ë¡œë“œ
curl -LO https://github.com/smallstep/cli/releases/download/v0.23.3/step_linux_0.23.3_amd64.tar.gz

# 2. ì••ì¶• í•´ì œ
tar -xzf step_linux_0.23.3_amd64.tar.gz

# 3. ë°”ì´ë„ˆë¦¬ ì´ë™
sudo mv step_0.23.3/bin/step /usr/local/bin/

# 4. ì •ìƒ ë™ì‘ í™•ì¸
step version

echo '3719' > pw.txt


-----BEGIN CERTIFICATE-----
MIIBsDCCAVagAwIBAgIRAJ7Npus6y8SyGVyBXQPkvRkwCgYIKoZIzj0EAwIwNjEV
MBMGA1UEChMMc21hcnRmYWN0b3J5MR0wGwYDVQQDExRzbWFydGZhY3RvcnkgUm9v
dCBDQTAeFw0yNTA2MDMwMjIzMDVaFw0zNTA2MDEwMjIzMDVaMDYxFTATBgNVBAoT
DHNtYXJ0ZmFjdG9yeTEdMBsGA1UEAxMUc21hcnRmYWN0b3J5IFJvb3QgQ0EwWTAT
BgcqhkjOPQIBBggqhkjOPQMBBwNCAAR0FTQK42y3l+XwfKHS70g0aaYHiHr2vyOG
ZVbFxAgRxqe+QR8gfrXn029SKqPjaNlJ6TCTrmntIkHk5rHrbrYgo0UwQzAOBgNV
HQ8BAf8EBAMCAQYwEgYDVR0TAQH/BAgwBgEB/wIBATAdBgNVHQ4EFgQUlYiFn1jk
zkbQZIRJEb4C06qz5a8wCgYIKoZIzj0EAwIDSAAwRQIhAMk8gFOlVuLo2YundZv0
PbSlZpsQYWd41fF2upmq5MldAiB35cvqUEI9XIzbeWnKyIEPfbs+nQ963D6Au8ZZ
md5rfA==
-----END CERTIFICATE-----




step-ca ì‹œì‘ ëª…ë ¹ì–´ sudo step-ca ~/.step/config/ca.json --password-file pw.txt


CREATE TABLE error_logs_sns (
    device_name     VARCHAR(50) NOT NULL,
    line_name       VARCHAR(50) NOT NULL,
    abnormal_count  INT NOT NULL,D
    triggered_at    DATETIME DEFAULT CURRENT_TIMESTAMP
);

sql ì ‘ì† ëª…ë ¹ì–´
mysql -h iot-db.c5a4e0ooeip0.us-east-2.rds.amazonaws.com -P 3306 -u admin -p

w


INSERT INTO error_logs_sns (device_name, value, timestamp)
VALUES ('washer', 70.5, NOW());










SELECT * FROM device_logs;

SELECT * FROM error_logs_sns;




âœ… 1ë‹¨ê³„: ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸ ì‘ì„±
ğŸ“ íŒŒì¼ ë§Œë“¤ê¸°
bash
ë³µì‚¬
í¸ì§‘
nano /home/ubuntu/start_capper.sh
âœï¸ ë‚´ìš© ì‘ì„±
bash
ë³µì‚¬
í¸ì§‘


#!/bin/bash

cd /home/ubuntu/smartfactory/devices/capper_device/certs || exit 1

step ca certificate \
  charger \
  mtls_capper.crt mtls_capper.key \
  --provisioner "SF.CA" \
  --password-file pw.txt \
  --ca-url https://10.1.2.112:443 \
  --root root_ca.crt

if [ $? -eq 0 ]; then
  echo "[âœ…] ì¸ì¦ì„œ ë°œê¸‰ ì™„ë£Œ, capper.py ì‹¤í–‰ ì‹œì‘"
  cd /home/ubuntu/smartfactory/devices/capper_device || exit 1
  source venv/bin/activate
  python3 capper.py
else
  echo "[âŒ] ì¸ì¦ì„œ ë°œê¸‰ ì‹¤íŒ¨, capper.py ì‹¤í–‰ ì•ˆ í•¨"
fi
ğŸ”“ ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
bash
ë³µì‚¬
í¸ì§‘
chmod +x /home/ubuntu/start_capper.sh
âœ… 2ë‹¨ê³„: ì¢…ë£Œ ì‹œ ì¸ì¦ì„œ ì‚­ì œ ìŠ¤í¬ë¦½íŠ¸ ì‘ì„±
bash
ë³µì‚¬
í¸ì§‘
nano /home/ubuntu/capper-cleanup.sh
âœï¸ ë‚´ìš© ì‘ì„±
bash
ë³µì‚¬
í¸ì§‘
#!/bin/bash
echo "[ğŸ§¹] ì¸ì¦ì„œ ì‚­ì œ ì¤‘..."
rm -f /home/ubuntu/smartfactory/devices/capper_device/certs/mtls_capper.*
bash
ë³µì‚¬
í¸ì§‘
chmod +x /home/ubuntu/capper-cleanup.sh
âœ… 3ë‹¨ê³„: systemd ì„œë¹„ìŠ¤ ë“±ë¡
bash
ë³µì‚¬
í¸ì§‘
sudo nano /etc/systemd/system/capper.service
âœï¸ ë‚´ìš© ì‘ì„±
ini
ë³µì‚¬
í¸ì§‘
[Unit]
Description=SmartFactory Capper Device Auto Start
After=network.target

[Service]
User=ubuntu
ExecStart=/home/ubuntu/start_capper.sh
ExecStopPost=/home/ubuntu/capper-cleanup.sh
WorkingDirectory=/home/ubuntu
Restart=on-failure
Environment=PATH=/home/ubuntu/smartfactory/devices/capper_device/venv/bin:/usr/bin
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
âœ… 4ë‹¨ê³„: systemd ì ìš©
bash
ë³µì‚¬
í¸ì§‘
sudo systemctl daemon-reexec
sudo systemctl daemon-reload
sudo systemctl enable capper
sudo systemctl start capper
âœ… 5ë‹¨ê³„: ìƒíƒœ ë° ë¡œê·¸ í™•ì¸
ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
bash
ë³µì‚¬
í¸ì§‘
sudo systemctl status capper
ì‹¤ì‹œê°„ ë¡œê·¸ ë³´ê¸°
bash
ë³µì‚¬
í¸ì§‘
journalctl -u capper -f





import pymysql
import boto3
import json

# RDS ì—°ê²° ì„¤ì •
DB_CONFIG = {
    "host": "iot-db.c5a4e0ooeip0.us-east-2.rds.amazonaws.com",
    "user": "admin",
    "password": "welcome1",
    "database": "smart_factory",
    "charset": "utf8mb4",
    "cursorclass": pymysql.cursors.DictCursor
}

# SQS ì—°ê²° ì„¤ì •
sqs = boto3.client('sqs', region_name='us-east-2')
QUEUE_URL = "https://sqs.us-east-2.amazonaws.com/207567776727/err_logs_sns_q"

def lambda_handler(event, context):
    print("Lambda ì‹¤í–‰ë¨ - RDSì—ì„œ ì—ëŸ¬ ë¡œê·¸ ì¡°íšŒ ì¤‘...")

    try:
        conn = pymysql.connect(**DB_CONFIG)
        with conn.cursor() as cursor:
            # 1. ì²˜ë¦¬ë˜ì§€ ì•Šì€ ë°ì´í„° ì¡°íšŒ (ì˜ˆ: ìµœëŒ€ 50ê±´)
            cursor.execute("SELECT * FROM error_logs_sns LIMIT 50")
            rows = cursor.fetchall()

            if not rows:
                print("ì²˜ë¦¬í•  ë°ì´í„° ì—†ìŒ.")
                return {"status": "No data"}

            for row in rows:
                # 2. ë©”ì‹œì§€ êµ¬ì„±
                msg = {
                    "device": row["device_name"],
                    "line": row["line_name"],
                    "value": row["last_abnormal_value"],
                    "count": row["abnormal_count"]
                }

                # 3. SQSë¡œ ì „ì†¡
                sqs.send_message(
                    QueueUrl=QUEUE_URL,
                    MessageBody=json.dumps(msg)
                )
                print(f"[â†’] SQS ì „ì†¡ë¨: {msg}")

                # 4. RDSì—ì„œ ì‚­ì œ
                cursor.execute("DELETE FROM error_logs_sns WHERE id = %s", (row["id"],))

            conn.commit()
            print("ì²˜ë¦¬ ì™„ë£Œ ë° ì‚­ì œë¨.")

        return {"status": "Success", "count": len(rows)}

    except Exception as e:
        print("âŒ ì—ëŸ¬:", str(e))
        return {"status": "Error", "message": str(e)}

    finally:
        if conn:
            conn.close()


import boto3
import json

sqs = boto3.client('sqs', region_name='us-east-2')
QUEUE_URL = "https://sqs.us-east-2.amazonaws.com/207567776727/err_logs_sns_q"

try:
    msg = {
        "device": "washer",
        "line": "line_1",
        "value": 64.2,
        "count": 6
    }

    res = sqs.send_message(
        QueueUrl=QUEUE_URL,
        MessageBody=json.dumps(msg)
    )

    print("[âœ…] SQS ì „ì†¡ ì„±ê³µ:", res["MessageId"])
except Exception as e:
    print("[âŒ] SQS ì „ì†¡ ì‹¤íŒ¨:", str(e))



import pymysql
import boto3
import json

# âœ… RDS ì—°ê²° ì„¤ì •
DB_CONFIG = {
    "host": "iot-db.c5a4e0ooeip0.us-east-2.rds.amazonaws.com",
    "user": "admin",
    "password": "welcome1",
    "database": "smart_factory",
    "charset": "utf8mb4",
    "cursorclass": pymysql.cursors.DictCursor,
    "connect_timeout": 5  # ğŸ”’ íƒ€ì„ì•„ì›ƒ ë°©ì§€
}

# âœ… SQS ì—°ê²° ì„¤ì •
sqs = boto3.client('sqs', region_name='us-east-2')
QUEUE_URL = "https://sqs.us-east-2.amazonaws.com/207567776727/err_logs_sns_q"

def lambda_handler(event, context):
    print("[1] Lambda ì‹œì‘ë¨")
    conn = None

    try:
        print("[2] DB ì—°ê²° ì‹œë„")
        conn = pymysql.connect(**DB_CONFIG)
        print("[3] ì—°ê²° ì„±ê³µ")

        with conn.cursor() as cursor:
            print("[4] ì¿¼ë¦¬ ì‹¤í–‰ ì‹œë„")
            cursor.execute("""
                SELECT id, device_name, line_name, last_abnormal_value, abnormal_count
                FROM error_logs_sns
                ORDER BY id ASC
                LIMIT 10
            """)
            rows = cursor.fetchall()
            print("[5] ì¿¼ë¦¬ ì‹¤í–‰ ì™„ë£Œ")

            if not rows:
                print("ì²˜ë¦¬í•  ë°ì´í„° ì—†ìŒ.")
                return {"status": "No data"}

            deleted_ids = []

            for row in rows:
                msg = {
                    "device": row["device_name"],
                    "line": row["line_name"],
                    "value": row["last_abnormal_value"],
                    "count": row["abnormal_count"]
                }

                try:
                    sqs.send_message(
                        QueueUrl=QUEUE_URL,
                        MessageBody=json.dumps(msg)
                    )
                    print(f"[â†’] SQS ì „ì†¡ë¨: {msg}")
                    deleted_ids.append(row["id"])
                except Exception as sqs_err:
                    print(f"[X] SQS ì „ì†¡ ì‹¤íŒ¨: {sqs_err} â†’ í•´ë‹¹ í•­ëª© ì‚­ì œ ë³´ë¥˜")

            # âœ… ì „ì†¡ ì„±ê³µí•œ ë°ì´í„°ë§Œ ì‚­ì œ
            if deleted_ids:
                format_strings = ','.join(['%s'] * len(deleted_ids))
                cursor.execute(
                    f"DELETE FROM error_logs_sns WHERE id IN ({format_strings})",
                    tuple(deleted_ids)
                )
                print(f"[âœ“] ì‚­ì œëœ ID: {deleted_ids}")

            conn.commit()
            print(f"[âœ“] ìµœì¢… ì»¤ë°‹ ì™„ë£Œ - ì²˜ë¦¬ ê±´ìˆ˜: {len(deleted_ids)}")
            return {"status": "Success", "count": len(deleted_ids)}

    except Exception as e:
        print("âŒ ì˜ˆì™¸ ë°œìƒ:", str(e))
        return {"status": "Error", "message": str(e)}

    finally:
        if conn:
            conn.close()
            print("[â„¹] DB ì—°ê²° ì¢…ë£Œë¨")


step-caë¡œ ë°œê¸‰ë°›ì€ ì¸ì¦ì„œê°€ ê¸°ê°„ ë§Œë£Œë˜ëŠ” ë¬¸ì œê°€ ë°œìƒí–ˆë‹¤. ì´ë¥¼ ì¸ìŠ¤í„´ìŠ¤ê°€ ì¼œì§ˆ ë•Œë§ˆë‹¤ ìƒˆë¡­ê²Œ ì¸ì¦ì„œë¥¼ ë°œê¸‰ë°›ëŠ” í˜•ì‹ìœ¼ë¡œ ìƒˆë¡œ êµ¬ì„±í•˜ì˜€ë‹¤. ë‹¤ìŒë²ˆì—ëŠ” ì¸ì¦ì„œ ê¸°ê°„ì„ ê´€ë¦¬í•˜ëŠ” ë°©ë²•ì„ ë°°ìš°ë©´ ì¢‹ì„ ê²ƒ ê°™ë‹¤ëŠ” ìƒê°ì´ ë“ ë‹¤.